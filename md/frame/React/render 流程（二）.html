<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>剖析 React 源码：render 流程（二） | 前端知识</title>
    <meta name="description" content="查缺补漏，厚积薄发">
    <link rel="icon" href="/ignore/images/favicon.ico">
  <link rel="manifest" href="/ignore/manifest.json">
  <link rel="stylesheet" href="/ignore/css/style.css">
    
    <link rel="preload" href="/ignore/assets/css/0.styles.af272f0a.css" as="style"><link rel="preload" href="/ignore/assets/js/app.ae63de62.js" as="script"><link rel="preload" href="/ignore/assets/js/2.8a6dc2e3.js" as="script"><link rel="preload" href="/ignore/assets/js/38.657869a7.js" as="script"><link rel="prefetch" href="/ignore/assets/js/10.8ba3da94.js"><link rel="prefetch" href="/ignore/assets/js/11.6d32525f.js"><link rel="prefetch" href="/ignore/assets/js/12.70cbde5e.js"><link rel="prefetch" href="/ignore/assets/js/13.2199ffb2.js"><link rel="prefetch" href="/ignore/assets/js/14.0941ce66.js"><link rel="prefetch" href="/ignore/assets/js/15.e8c6b849.js"><link rel="prefetch" href="/ignore/assets/js/16.63005794.js"><link rel="prefetch" href="/ignore/assets/js/17.38bf4b2d.js"><link rel="prefetch" href="/ignore/assets/js/18.7cfdfd39.js"><link rel="prefetch" href="/ignore/assets/js/19.79e6480d.js"><link rel="prefetch" href="/ignore/assets/js/20.ce49bf98.js"><link rel="prefetch" href="/ignore/assets/js/21.a1abce40.js"><link rel="prefetch" href="/ignore/assets/js/22.fcbcd29a.js"><link rel="prefetch" href="/ignore/assets/js/23.11659f11.js"><link rel="prefetch" href="/ignore/assets/js/24.71b9f548.js"><link rel="prefetch" href="/ignore/assets/js/25.40660b8d.js"><link rel="prefetch" href="/ignore/assets/js/26.2e490d8f.js"><link rel="prefetch" href="/ignore/assets/js/27.379adacb.js"><link rel="prefetch" href="/ignore/assets/js/28.2e613321.js"><link rel="prefetch" href="/ignore/assets/js/29.da330e76.js"><link rel="prefetch" href="/ignore/assets/js/3.e108419e.js"><link rel="prefetch" href="/ignore/assets/js/30.ce0912be.js"><link rel="prefetch" href="/ignore/assets/js/31.26b19e98.js"><link rel="prefetch" href="/ignore/assets/js/32.c531a999.js"><link rel="prefetch" href="/ignore/assets/js/33.53a2f990.js"><link rel="prefetch" href="/ignore/assets/js/34.a37034ac.js"><link rel="prefetch" href="/ignore/assets/js/35.2879a806.js"><link rel="prefetch" href="/ignore/assets/js/36.caf1f969.js"><link rel="prefetch" href="/ignore/assets/js/37.cfa6b9eb.js"><link rel="prefetch" href="/ignore/assets/js/39.b7da0da6.js"><link rel="prefetch" href="/ignore/assets/js/4.d1c75c66.js"><link rel="prefetch" href="/ignore/assets/js/40.4870d267.js"><link rel="prefetch" href="/ignore/assets/js/41.e5984042.js"><link rel="prefetch" href="/ignore/assets/js/42.e2364288.js"><link rel="prefetch" href="/ignore/assets/js/43.234ca59b.js"><link rel="prefetch" href="/ignore/assets/js/44.3af77e17.js"><link rel="prefetch" href="/ignore/assets/js/45.39ec0b64.js"><link rel="prefetch" href="/ignore/assets/js/46.7328d8cb.js"><link rel="prefetch" href="/ignore/assets/js/47.863f032d.js"><link rel="prefetch" href="/ignore/assets/js/48.de3f2e1c.js"><link rel="prefetch" href="/ignore/assets/js/49.5992f480.js"><link rel="prefetch" href="/ignore/assets/js/5.29b118d6.js"><link rel="prefetch" href="/ignore/assets/js/50.25535208.js"><link rel="prefetch" href="/ignore/assets/js/51.22f8ab6a.js"><link rel="prefetch" href="/ignore/assets/js/52.985b8c7a.js"><link rel="prefetch" href="/ignore/assets/js/53.e2e85bac.js"><link rel="prefetch" href="/ignore/assets/js/54.e678090d.js"><link rel="prefetch" href="/ignore/assets/js/55.c85fa7de.js"><link rel="prefetch" href="/ignore/assets/js/56.6022f7a5.js"><link rel="prefetch" href="/ignore/assets/js/57.1d3c4c18.js"><link rel="prefetch" href="/ignore/assets/js/58.25b36258.js"><link rel="prefetch" href="/ignore/assets/js/59.845a3460.js"><link rel="prefetch" href="/ignore/assets/js/6.9f09646a.js"><link rel="prefetch" href="/ignore/assets/js/60.5ff535ce.js"><link rel="prefetch" href="/ignore/assets/js/61.ea764213.js"><link rel="prefetch" href="/ignore/assets/js/62.b262201f.js"><link rel="prefetch" href="/ignore/assets/js/63.3443883e.js"><link rel="prefetch" href="/ignore/assets/js/64.b1dffc47.js"><link rel="prefetch" href="/ignore/assets/js/65.db2b3af3.js"><link rel="prefetch" href="/ignore/assets/js/66.2706fdf2.js"><link rel="prefetch" href="/ignore/assets/js/67.b0a3cb2f.js"><link rel="prefetch" href="/ignore/assets/js/68.2cd89efe.js"><link rel="prefetch" href="/ignore/assets/js/69.de33350e.js"><link rel="prefetch" href="/ignore/assets/js/7.9dc13833.js"><link rel="prefetch" href="/ignore/assets/js/70.7bc7f071.js"><link rel="prefetch" href="/ignore/assets/js/71.37f11d96.js"><link rel="prefetch" href="/ignore/assets/js/72.a04444b8.js"><link rel="prefetch" href="/ignore/assets/js/73.27c49676.js"><link rel="prefetch" href="/ignore/assets/js/74.dbabf564.js"><link rel="prefetch" href="/ignore/assets/js/75.3284bee8.js"><link rel="prefetch" href="/ignore/assets/js/76.59f6e624.js"><link rel="prefetch" href="/ignore/assets/js/77.46149523.js"><link rel="prefetch" href="/ignore/assets/js/78.3f459f71.js"><link rel="prefetch" href="/ignore/assets/js/79.804fd229.js"><link rel="prefetch" href="/ignore/assets/js/8.210c94c0.js"><link rel="prefetch" href="/ignore/assets/js/80.66f21a4d.js"><link rel="prefetch" href="/ignore/assets/js/81.b2ed4a12.js"><link rel="prefetch" href="/ignore/assets/js/82.4e5c150a.js"><link rel="prefetch" href="/ignore/assets/js/83.9d72408b.js"><link rel="prefetch" href="/ignore/assets/js/84.5888e60e.js"><link rel="prefetch" href="/ignore/assets/js/85.4ae541ca.js"><link rel="prefetch" href="/ignore/assets/js/86.82a73d55.js"><link rel="prefetch" href="/ignore/assets/js/87.c117ac29.js"><link rel="prefetch" href="/ignore/assets/js/88.491214d5.js"><link rel="prefetch" href="/ignore/assets/js/89.6b647d6a.js"><link rel="prefetch" href="/ignore/assets/js/9.524ed2fa.js"><link rel="prefetch" href="/ignore/assets/js/90.23492b12.js"><link rel="prefetch" href="/ignore/assets/js/91.d03800ac.js"><link rel="prefetch" href="/ignore/assets/js/92.422d52f2.js"><link rel="prefetch" href="/ignore/assets/js/93.0de7e4d3.js"><link rel="prefetch" href="/ignore/assets/js/94.44f449b4.js"><link rel="prefetch" href="/ignore/assets/js/95.99a8ec66.js">
    <link rel="stylesheet" href="/ignore/assets/css/0.styles.af272f0a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ignore/" class="home-link router-link-active"><!----> <span class="site-name">前端知识</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/ignore/md/resource/resource.html" class="nav-link">资源工具</a></div><div class="nav-item"><a href="/ignore/md/introduction/introduction.html" class="nav-link">导读</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Javascript" class="dropdown-title"><span class="title">Javascript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ignore/md/js/jsBasic/" class="nav-link">JavaScript基础</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/js/jsHigh/" class="nav-link">JavaScript进阶</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/js/es6/" class="nav-link">ECMAScript 6</a></li><li class="dropdown-item"><h4>JS书籍</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ignore/md/js/book/你不知道的javascript上.html" class="nav-link">你不知道的JavaScript(上)</a></li><li class="dropdown-subitem"><a href="/ignore/md/js/book/你不知道的javascript中.html" class="nav-link">你不知道的JavaScript(中下)</a></li><li class="dropdown-subitem"><a href="/ignore/md/js/book/es6.html" class="nav-link">深入理解ES6</a></li><li class="dropdown-subitem"><a href="/ignore/md/js/book/algorithm.html" class="nav-link">JavaScript数据结构和算法</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端概括" class="dropdown-title"><span class="title">前端概括</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ignore/md/webBasics/CSS/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/webBasics/HTML5/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/webBasics/Node/" class="nav-link">Node.js</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/webBasics/property/" class="nav-link">性能/监控</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/webBasics/allPath/" class="nav-link">全链路开发</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/webBasics/scope/" class="nav-link">领域分支</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架/库" class="dropdown-title"><span class="title">框架/库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ignore/md/frame/Vue/" class="nav-link">Vue.js</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/frame/React/" class="nav-link router-link-active">React</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/frame/Angular/" class="nav-link">Angular</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/frame/jQuery/" class="nav-link">jQuery</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/frame/Class/" class="nav-link">类库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日积月累" class="dropdown-title"><span class="title">日积月累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ignore/md/codeBlock/module/" class="nav-link">代码模块</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/codeBlock/week/" class="nav-link">每周汇总</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/codeBlock/jobInterview/" class="nav-link">面试收集</a></li><li class="dropdown-item"><h4>方法论</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ignore/md/codeBlock/methodology/1.html" class="nav-link">编程思想</a></li><li class="dropdown-subitem"><a href="/ignore/md/codeBlock/methodology/2.html" class="nav-link">开发原则</a></li><li class="dropdown-subitem"><a href="/ignore/md/codeBlock/methodology/3.html" class="nav-link">开发流程</a></li><li class="dropdown-subitem"><a href="/ignore/md/codeBlock/methodology/6.html" class="nav-link">代码规范</a></li><li class="dropdown-subitem"><a href="/ignore/md/codeBlock/methodology/4.html" class="nav-link">设计模式</a></li><li class="dropdown-subitem"><a href="/ignore/md/codeBlock/methodology/5.html" class="nav-link">开源协议</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/ignore/md/about/" class="nav-link">关于我</a></div> <a href="https://github.com/lizheng0515/ignore/issues" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/ignore/md/resource/resource.html" class="nav-link">资源工具</a></div><div class="nav-item"><a href="/ignore/md/introduction/introduction.html" class="nav-link">导读</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Javascript" class="dropdown-title"><span class="title">Javascript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ignore/md/js/jsBasic/" class="nav-link">JavaScript基础</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/js/jsHigh/" class="nav-link">JavaScript进阶</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/js/es6/" class="nav-link">ECMAScript 6</a></li><li class="dropdown-item"><h4>JS书籍</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ignore/md/js/book/你不知道的javascript上.html" class="nav-link">你不知道的JavaScript(上)</a></li><li class="dropdown-subitem"><a href="/ignore/md/js/book/你不知道的javascript中.html" class="nav-link">你不知道的JavaScript(中下)</a></li><li class="dropdown-subitem"><a href="/ignore/md/js/book/es6.html" class="nav-link">深入理解ES6</a></li><li class="dropdown-subitem"><a href="/ignore/md/js/book/algorithm.html" class="nav-link">JavaScript数据结构和算法</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端概括" class="dropdown-title"><span class="title">前端概括</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ignore/md/webBasics/CSS/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/webBasics/HTML5/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/webBasics/Node/" class="nav-link">Node.js</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/webBasics/property/" class="nav-link">性能/监控</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/webBasics/allPath/" class="nav-link">全链路开发</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/webBasics/scope/" class="nav-link">领域分支</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架/库" class="dropdown-title"><span class="title">框架/库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ignore/md/frame/Vue/" class="nav-link">Vue.js</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/frame/React/" class="nav-link router-link-active">React</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/frame/Angular/" class="nav-link">Angular</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/frame/jQuery/" class="nav-link">jQuery</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/frame/Class/" class="nav-link">类库</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="日积月累" class="dropdown-title"><span class="title">日积月累</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ignore/md/codeBlock/module/" class="nav-link">代码模块</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/codeBlock/week/" class="nav-link">每周汇总</a></li><li class="dropdown-item"><!----> <a href="/ignore/md/codeBlock/jobInterview/" class="nav-link">面试收集</a></li><li class="dropdown-item"><h4>方法论</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ignore/md/codeBlock/methodology/1.html" class="nav-link">编程思想</a></li><li class="dropdown-subitem"><a href="/ignore/md/codeBlock/methodology/2.html" class="nav-link">开发原则</a></li><li class="dropdown-subitem"><a href="/ignore/md/codeBlock/methodology/3.html" class="nav-link">开发流程</a></li><li class="dropdown-subitem"><a href="/ignore/md/codeBlock/methodology/6.html" class="nav-link">代码规范</a></li><li class="dropdown-subitem"><a href="/ignore/md/codeBlock/methodology/4.html" class="nav-link">设计模式</a></li><li class="dropdown-subitem"><a href="/ignore/md/codeBlock/methodology/5.html" class="nav-link">开源协议</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/ignore/md/about/" class="nav-link">关于我</a></div> <a href="https://github.com/lizheng0515/ignore/issues" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ignore/md/frame/React/热身篇.html" class="sidebar-link">热身篇</a></li><li><a href="/ignore/md/frame/React/组件更新流程一（调度任务）.html" class="sidebar-link">组件更新流程一（调度任务）</a></li><li><a href="/ignore/md/frame/React/组件更新流程二（diff 策略）.html" class="sidebar-link">组件更新流程二（diff 策略）</a></li><li><a href="/ignore/md/frame/React/调度原理.html" class="sidebar-link">调度原理</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="剖析-react-源码：render-流程（二）"><a href="#剖析-react-源码：render-流程（二）" class="header-anchor">#</a> 剖析 React 源码：render 流程（二）</h1> <p>这是剖析 React 源码的第三篇文章，如果你没有阅读过之前的文章，请务必先阅读一下 <a href="https://github.com/KieSun/Dream/issues/18" target="_blank" rel="noopener noreferrer">第一篇文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中提到的一些注意事项，能帮助你更好地阅读源码。</p> <h2 id="reactroot-prototype-render"><a href="#reactroot-prototype-render" class="header-anchor">#</a> ReactRoot.prototype.render</h2> <p>在上一篇文章中，我们介绍了当 <code>ReactDom.render</code> 执行时，内部会首先判断是否已经存在 <code>root</code>，没有的话会去创建一个 <code>root</code>。在今天的文章中，我们将会了解到存在 <code>root</code> 以后会发生什么事情。</p> <p>大家可以先定位到代码的第 592 行。</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-031954.png" alt=""></p> <p>大家可以看到，在上述的代码中调用了 <code>unbatchedUpdates</code> 函数，这个函数涉及到的知识其实在 React 中相当重要。</p> <p>大家都知道多个 <code>setState</code> 一起执行，并不会触发 React 的多次渲染。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 虽然 age 会变成 3，但不会触发 3 次渲染</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> age<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> age<span class="token punctuation">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> age<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这是因为内部会将这个三次 <code>setState</code> 优化为一次更新，术语是批量更新（batchedUpdate），我们在后续的内容中也能看到内部是如何处理批量更新的。</p> <p>对于 root 来说其实没必要去批量更新，所以这里调用了 <code>unbatchedUpdates</code> 函数来告知内部不需要批量更新。</p> <p>然后在 <code>unbatchedUpdates</code> 回调内部判断是否存在 <code>parentComponent</code>。这一步我们可以假定不会存在 <code>parentComponent</code>，因为很少有人会在 <code>root</code> 外部加上 <code>context</code> 组件。不存在 <code>parentComponent</code> 的话就会执行 <code>root.render(children, callback)</code>，这里的 <code>render</code> 指的是 <code>ReactRoot.prototype.render</code>。</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-031956.png" alt=""></p> <p>在 <code>render</code> 函数内部我们首先取出 <code>root</code>，这里的 <code>root</code> 指的是 FiberRoot，如果你想了解 FiberRoot 相关的内容可以阅读 <a href="https://github.com/KieSun/Dream/issues/19" target="_blank" rel="noopener noreferrer">上一篇文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。然后创建了 <code>ReactWork</code> 的实例，这块内容我们没有必要深究，功能就是为了在组件渲染或更新后把所有传入 <code>ReactDom.render</code> 中的回调函数全部执行一遍。</p> <p>接下来我们来看 <code>updateContainer</code> 内部是怎么样的。</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-031958.png" alt=""></p> <p>我们先从 FiberRoot 的 <code>current</code> 属性中取出它的 fiber 对象，然后计算了两个时间。这两个时间在 React 中相当重要，因此我们需要单独用一小节去学习它们。</p> <h2 id="时间"><a href="#时间" class="header-anchor">#</a> 时间</h2> <p>首先是 <code>currentTime</code>，在 <code>requestCurrentTime</code> 函数内部计算时间的最核心函数是 <code>recomputeCurrentRendererTime</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> currentTimeMs <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> originalStartTimeMs<span class="token punctuation">;</span>
	currentRendererTime <span class="token operator">=</span> <span class="token function">msToExpirationTime</span><span class="token punctuation">(</span>currentTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>now()</code> 就是 <code>performance.now()</code>，如果你不了解这个 API 的话可以阅读下 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/now" target="_blank" rel="noopener noreferrer">相关文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，<code>originalStartTimeMs</code> 是 React 应用初始化时就会生成的一个变量，值也是 <code>performance.now()</code>，并且这个值不会在后期再被改变。那么这两个值相减以后，得到的结果也就是现在离 React 应用初始化时经过了多少时间。</p> <p>然后我们需要把计算出来的值再通过一个公式算一遍，这里的 <code>| 0</code> 作用是取整数，也就是说 <code>11 / 10 | 0 = 1</code></p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-031959.png" alt=""></p> <p>接下来我们来假定一些变量值，代入公式来算的话会更方便大家理解。</p> <p>假如 <code>originalStartTimeMs</code> 为 <code>2500</code>，当前时间为 <code>5000</code>，那么算出来的差值就是 <code>2500</code>，也就是说当前距离 React 应用初始化已经过去了 2500 毫秒，最后通过公式得出的结果为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>currentTime <span class="token operator">=</span> <span class="token number">1073741822</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2500</span> <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1073741572</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接下来是计算 <code>expirationTime</code>，<strong>这个时间和优先级有关，值越大，优先级越高</strong>。并且同步是优先级最高的，它的值为 <code>1073741823</code>，也就是之前我们看到的常量 <code>MAGIC_NUMBER_OFFSET</code> 加一。</p> <p>在 <code>computeExpirationForFiber</code> 函数中存在很多分支，但是计算的核心就只有三行代码，分别是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 同步</span>
expirationTime <span class="token operator">=</span> Sync
<span class="token comment">// 交互事件，优先级较高</span>
expirationTime <span class="token operator">=</span> <span class="token function">computeInteractiveExpiration</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span>
<span class="token comment">// 异步，优先级较低</span>
expirationTime <span class="token operator">=</span> <span class="token function">computeAsyncExpiration</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>接下来我们就来分析 <code>computeInteractiveExpiration</code> 函数内部是如何计算时间的，当然 <code>computeAsyncExpiration</code> 计算时间的方式也是相同的，无非更换了两个变量。</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-032001.png" alt=""></p> <p>以上这些代码其实就是公式，我们把具体的值代入就能算出结果了。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>time <span class="token operator">=</span> <span class="token number">1073741822</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1073741822</span> <span class="token operator">-</span> <span class="token number">1073741572</span> <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">=</span> <span class="token number">1073741552</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>另外在 <code>ceiling</code> 函数中的 <code>1 * bucketSizeMs / UNIT_SIZE</code> 是为了抹平一段时间内的时间差，在抹平的时间差内不管有多少个任务需要执行，他们的过期时间都是同一个，这也算是一个性能优化，帮助渲染页面行为节流。</p> <p>最后其实我们这个计算出来的 <code>expirationTime</code> 是可以反推出另外一个时间的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span><span class="token parameter">expirationTime<span class="token punctuation">:</span> ExpirationTime</span><span class="token punctuation">)</span><span class="token punctuation">:</span> number <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token constant">MAGIC_NUMBER_OFFSET</span> <span class="token operator">-</span> expirationTime<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">UNIT_SIZE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果我们将之前计算出来的 <code>expirationTime</code> 代入以上代码，得出的结果如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token number">1073741822</span> <span class="token operator">-</span> <span class="token number">1073741552</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">=</span> <span class="token number">2700</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这个时间其实和我们之前在上文中计算出来的 <code>2500</code> 毫秒差值很接近。因为 <code>expirationTime</code> 指的就是一个任务的过期时间，React 根据任务的优先级和当前时间来计算出一个任务的执行截止时间。只要这个值比当前时间大就可以一直让 React 延后这个任务的执行，以便让更高优先级的任务执行，但是一旦过了任务的截止时间，就必须让这个任务马上执行。</p> <p>这部分的内容一直在算来算去，看起来可能有点头疼。当然如果你嫌麻烦，只需要记住任务的过期时间是通过当前时间加上一个常量（任务优先级不同常量不同）计算出来的。</p> <p>另外其实你还可以在后面的代码中看到更加直观且简单的计算过期时间的方式，但是目前那部分代码还没有被使用起来。</p> <h2 id="schedulerootupdate"><a href="#schedulerootupdate" class="header-anchor">#</a> scheduleRootUpdate</h2> <p>当我们计算出时间以后就会调用 <code>updateContainerAtExpirationTime</code>，这个函数其实没有什么好解析的，我们直接进入 <code>scheduleRootUpdate</code> 函数就好。</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-032002.png" alt=""></p> <p>首先我们会创建一个 <code>update</code>，<strong>这个对象和 <code>setState</code> 息息相关</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// update 对象的内部属性</span>
expirationTime<span class="token punctuation">:</span> expirationTime<span class="token punctuation">,</span>
tag<span class="token punctuation">:</span> UpdateState<span class="token punctuation">,</span>
<span class="token comment">// setState 的第一二个参数</span>
payload<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
callback<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token comment">// 用于在队列中找到下一个节点</span>
next<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
nextEffect<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>对于 <code>update</code> 对象内部的属性来说，我们需要重点关注的是 <code>next</code> 属性。因为 <code>update</code> 其实就是一个队列中的节点，这个属性可以用于帮助我们寻找下一个 <code>update</code>。对于批量更新来说，我们可能会创建多个 <code>update</code>，因此我们需要将这些 <code>update</code> 串联并存储起来，在必要的时候拿出来用于更新 <code>state</code>。</p> <p>在 <code>render</code> 的过程中其实也是一次更新的操作，但是我们并没有 <code>setState</code>，因此就把 <code>payload</code> 赋值为 <code>{element}</code> 了。</p> <p>接下来我们将 <code>callback</code> 赋值给 <code>update</code> 的属性，这里的 <code>callback</code> 还是 <code>ReactDom.render</code> 的第三个参数。</p> <p>然后我们将刚才创建出来的 <code>update</code> 对象插入队列中，<code>enqueueUpdate</code> 函数内部分支较多且代码简单，这里就不再贴出代码了，有兴趣的可以自行阅读。函数核心作用就是创建或者获取一个队列，然后把 <code>update</code> 对象入队。</p> <p>最后调用 <code>scheduleWork</code> 函数，这里开始就是调度相关的内容，这部分内容我们将在下一篇文章中来详细解析。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>以上就是本文的全部内容了，这篇文章其实核心还是放在了计算时间上，因为这个时间和后面的调度息息相关，最后通过一张流程图总结一下 render 流程两篇文章的内容。</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-032003.png" alt=""></p> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <p>阅读源码是一个很枯燥的过程，但是收益也是巨大的。如果你在阅读的过程中有任何的问题，都欢迎你在评论区与我交流。</p> <p>另外写这系列是个很耗时的工程，需要维护代码注释，还得把文章写得尽量让读者看懂，最后还得配上画图，如果你觉得文章看着还行，就请不要吝啬你的点赞。</p> <p>下一篇文章还是 render 流程相关的内容。</p> <p>最后，觉得内容有帮助可以关注下我的公众号 「前端真好玩」咯，会有很多好东西等着你。</p> <p><img src="https://yck-1254263422.cos.ap-shanghai.myqcloud.com/blog/2019-06-01-032004.jpg" alt=""></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/ignore/assets/js/app.ae63de62.js" defer></script><script src="/ignore/assets/js/2.8a6dc2e3.js" defer></script><script src="/ignore/assets/js/38.657869a7.js" defer></script>
  </body>
</html>
